<html>
<meta http-equiv='Content-Type' content='text/html; charset=UTF-8' />
<link rel='stylesheet' type='text/css' href='/style.css'>
<link rel='stylesheet' type='text/css' href="/jquery-ui.css">
<script src="/js/jquery-2.1.4.min.js"></script>
<script type="text/javascript" src="/js/jquery-ui.min.js"></script>
<link href='/jquery-ui-timepicker-addon.css' rel='stylesheet'>
<script src="/js/jquery-ui-timepicker-addon.js"></script>
<script src="/js/jquery-ui-sliderAccess.js"></script>



<!--<script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>-->
<script language='javascript'>
function DoAjax(requestUrl, sentData, sHandler, eHandler, pageNotFoundHandler){
        $.ajax({
            type: 'GET',    
            url: requestUrl,
            cache: false,       
            data: sentData, 
            success: sHandler,   
            error: eHandler,      
            statusCode: {    
              404: pageNotFoundHandler
            }
        });
    };
function qRange()
{
    $('#mainDiv').html("Querying...")

    editSym = $('#editSym').val()
    selectType = $('#selectType').val()
    editBeg = $('#editBeg').val()
    editEnd = $('#editEnd').val() 

    url='/cgi-bin/qRange.py?symbol='+editSym+'&type='+selectType+'&BEG='+editBeg+'&END='+editEnd
    DoAjax(url, {},
        function(data, textStatus, jqXHR){
		makeMainTable(data);
        }); 
}
function doupdate(idx, sym, desc, bpv, mko, mkc, ssec){
 //alert('ready to update: '+sym+', desc:'+desc+', bpv:'+bpv)
 location.href='/cgi-bin/usymbol.py?sym='+encodeURI(sym)+'&desc='+desc+'&bpv='+bpv+'&mko='+mko+'&mkc='+mkc+
               '&ssec='+ssec;
}
function doimport1min(idx, sym){
 location.href='/i1min.html?sym='+encodeURI(sym);
}
function strQDay(datetime){
    var dd = datetime.getDate();
    var mm = datetime.getMonth()+1; //January is 0!
    var yyyy = datetime.getFullYear();
    return yyyy+"-"+mm+"-"+dd
}
function doq1min(idx, sym){
    var begday = new Date();
    begday.setDate(begday.getDate() - 3);
    var endday = new Date(); 
    endday.setDate(endday.getDate() + 3);
    beg = strQDay(begday) 
    end = strQDay(endday)
    window.open('/cgi-bin/q1min.py?symbol='+encodeURI(sym)+'&BEG='+beg+"&END="+end, "_blank", "");
}
function doq1sec(idx, sym){
    var begday = new Date();
    begday.setDate(begday.getDate() - 3);
    var endday = new Date();
    endday.setDate(endday.getDate() + 3);
    beg = strQDay(begday)
    end = strQDay(endday)
    window.open('/cgi-bin/q1sec.py?symbol='+encodeURI(sym)+'&BEG='+beg+"&END="+end, "_blank", "");
}
function dosummery(idx, sym){
    window.open('/cgi-bin/qsummery.py?symbol='+encodeURI(sym), "_blank", "");
}
function showDlg(floatDT){
    floatDT = parseFloat(floatDT);
    $('#barSym').html(barData['symbol'])
    $('#barType').html(barData['type'])
    barIdx = barData['dataDict'][floatDT]
    bar = barData['data'][barIdx]
    var d = new Date(0);
    d.setUTCMilliseconds(floatDT*1000)
    dtstr = d.getFullYear() + "-" + ("00" + (d.getMonth() + 1)).slice(-2) + "-" + ("00" + d.getDate()).slice(-2) + " " +
            ("00" + d.getHours()).slice(-2) + ":" + ("00" + d.getMinutes()).slice(-2) + ":" + ("00" + d.getSeconds()).slice(-2) + "." + (d.getMilliseconds()+"000").substr(0,3)

    $('#barDT').html(dtstr)
    barOHL_disable=false
    if (barData['type'] == 'minbar' || barData['type'] == 'secbar')
    {   
        barOHL_disable=false
        $('#barOpen').val(bar['o'])
        $('#barHigh').val(bar['h'])
        $('#barLow').val(bar['l'])
    }
    else
    {
        barOHL_disable=true;
        $('#barOpen').val('N/A')
        $('#barHigh').val('N/A')
        $('#barLow').val('N/A')

    }
    $('#barOpen').prop('disabled', barOHL_disable);
    $('#barHigh').prop('disabled', barOHL_disable);
    $('#barLow').prop('disabled', barOHL_disable);

    $('#barClose').val(bar['c'])
    $('#barVol').val(bar['v'])
    var modal = document.getElementById('modifyBar');
    modal.style.display = "block";
}
function closeDlg(){
    var modal = document.getElementById('modifyBar');
    modal.style.display = "none";
}
barData = {'range':null, 'symbol':'', 'type':'', 'data':[], 'dataDict':{}}
function makeMainTable(jsonObj)
{
    barData = jsonObj;
    barData['dataDict']={}

    range = barData['range']
    bars = barData['data']
    len = bars.length;
    if (len<=0)
    {
        $('#mainDiv').html("===No Data===")
        return;
    }
    strTable="<table>"
    strTable+="<tr class='grayThing smallfont'><td>Timestamp</td><td>Datetime</td><td>Open</td><td>High</td><td>Low</td><td>Close</td><td>Vol</td></tr>"
    
    for (idx=0;idx<len;++idx)
    {
        bar = bars[idx]
        floatDT = parseFloat(bar['dt']);
        barData['dataDict'][floatDT] = idx;        
        var d = new Date(0);
	d.setUTCMilliseconds(floatDT*1000)
        dtstr = d.getFullYear() + "-" + ("00" + (d.getMonth() + 1)).slice(-2) + "-" + ("00" + d.getDate()).slice(-2) + " " + 
               ("00" + d.getHours()).slice(-2) + ":" + ("00" + d.getMinutes()).slice(-2) + ":" + ("00" + d.getSeconds()).slice(-2) + "." + (d.getMilliseconds()+"000").substr(0,3) 
        o='N/A';
        h='N/A';
        l='N/A';
        c=bar['c'];
        v=bar['v'];
        if (barData['type'] == 'minbar' || barData['type'] == 'secbar')
        {
            o=bar['o'];h=bar['h'];l=bar['l'];
        }
        strTable+="<tr onmouseover=\"this.className='yellowThing';\" onmouseout=\"this.className='whiteThing';\" onclick=\"showDlg("+floatDT+");\" >"
        strTable+="<td>"+floatDT.toFixed(3)+"</td>"
        strTable+="<td>"+dtstr+"</td>"
        strTable+="<td>"+o+"</td>"
        strTable+="<td>"+h+"</td>"
        strTable+="<td>"+l+"</td>"
        strTable+="<td>"+c+"</td>"
        strTable+="<td>"+v+"</td>"
        strTable+="</tr>"
    }
    strTable+="</table>"
    document.getElementById('mainDiv').innerHTML = strTable;
}
function getFormattedDate(date) {
    var day = date.getDate();
    var month = date.getMonth() + 1;
    var year = date.getFullYear().toString().slice(2);
    return day + '-' + month + '-' + year;
}
function bodyonload()
{
    $('#editBeg').datetimepicker({dateFormat: 'yy-mm-dd',format:'HH:mm:ss', value: new Date()});
    $('#editEnd').datetimepicker({dateFormat: 'yy-mm-dd',format:'HH:mm:ss', value: new Date()});
    //alert(1)
}
</script>
<body onload='bodyonload();'>
<!-- The Modal -->
<div id='inputDiv'>
Symbol:<input type='text' id='editSym' size=10>&nbsp;
Type:<select id='selectType'><option value="minbar" selected>1 Min Bar</option><option value="secbar">1 Second Bar</option><option value="tick">Tick</option></select>&nbsp;
Range:<input type='text' id='editBeg' size=14>&nbsp;~&nbsp;<input type='text' id='editEnd' size=14>&nbsp;<br>
<input type='button' value='Query' onclick='qRange()'>
<hr>
</div>
<div id='mainDiv' ></div>
<div id="modifyBar" class='modal'>
  <!-- Modal content -->
  <div class="modal-content">
    <span class="close" onclick="closeDlg();">x</span>
    <p>
    <span>Symbol:&nbsp;<span id='barSym'></span>&nbsp;&nbsp;&nbsp;Type:&nbsp;<span id='barType'></span></span>
		<table>
		<tr class='grayThing smallfont'><td>Datetime</td><td>Open</td><td>High</td><td>Low</td><td>Close</td><td>Volume</td></tr>
                <tr><td><div id='barDT'></div></td>
                    <td><input type='text' id='barOpen' size='6'></td>
		    <td><input type='text' id='barHigh' size='6'></td>
		    <td><input type='text' id='barLow' size='6'></td>
		    <td><input type='text' id='barClose' size='6'></td>
                    <td><input type='text' id='barVol' size='6'></td>
		</tr>
                <tr><td colspan='6'>
			<button type='button' value='' onclick="dosummery($('#dlgSymIdx').text()*1, $('#dlgSym').text())">Update</button>&nbsp;
			<button type='button' value='' onclick="doq1min($('#dlgSymIdx').text()*1, $('#dlgSym').text())">Delete</button>&nbsp;
		</td>
		</table>
    </p>
  </div>
</div>
</body></html>
